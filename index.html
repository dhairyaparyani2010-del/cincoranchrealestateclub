<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Firebase Setup ---
setLogLevel('Debug');
let db, auth, userId, appId;
const COLLECTION_NAME = "expenses";
const getCollectionPath = (appId) => `/artifacts/${appId}/public/data/${COLLECTION_NAME}`;

const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

async function setupFirebase() {
    try {
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-crrc-app';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }

        userId = auth.currentUser?.uid || crypto.randomUUID();
        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;

        listenForExpenses();
    } catch (e) {
        console.error("Firebase setup error:", e);
        document.getElementById('expense-status')?.textContent = "Cannot connect to Firebase.";
    }
}

// --- Expense Handling ---
function listenForExpenses() {
    if (!db || !appId) return;
    const q = query(collection(db, getCollectionPath(appId)));

    onSnapshot(q, snapshot => {
        const expenses = [];
        let totalIncome = 0, totalExpense = 0;

        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const expense = { id: docSnap.id, ...data };
            expenses.push(expense);
            if (data.type === 'income') totalIncome += parseFloat(data.amount) || 0;
            else if (data.type === 'expense') totalExpense += parseFloat(data.amount) || 0;
        });

        expenses.sort((a,b) => (b.timestamp?.toDate?.()?.getTime()||0) - (a.timestamp?.toDate?.()?.getTime()||0));
        renderExpenses(expenses);
        renderSummary(totalIncome, totalExpense);
    }, console.error);
}

async function addExpense(event) {
    event.preventDefault();
    const description = document.getElementById('expense-description').value.trim();
    const amount = parseFloat(document.getElementById('expense-amount').value);
    const type = document.getElementById('expense-type').value;
    const messageEl = document.getElementById('expense-message');

    if (!description || isNaN(amount) || amount <= 0) {
        showMessage(messageEl, "Enter valid description and amount.", 'red');
        return;
    }
    if (!db || !appId) return console.error("Database not initialized");

    try {
        await addDoc(collection(db, getCollectionPath(appId)), {
            description, amount, type, timestamp: serverTimestamp(), recordedBy: userId
        });
        document.getElementById('add-expense-form').reset();
        showMessage(messageEl, `${type === 'income' ? 'Income' : 'Expense'} recorded successfully!`, 'green');
    } catch (e) {
        console.error("Error adding expense:", e);
        showMessage(messageEl, "Error recording transaction.", 'red');
    }
}

async function deleteExpense(id) {
    if (!db || !appId) return console.error("Database not initialized");
    try {
        await deleteDoc(doc(db, getCollectionPath(appId), id));
    } catch(e) {
        console.error("Error deleting expense:", e);
    }
}

// --- Render Functions ---
function renderExpenses(expenses) {
    const list = document.getElementById('expense-list');
    list.innerHTML = '';
    if (!expenses.length) return list.innerHTML = `<li class="p-6 text-center text-gray-400">No transactions recorded yet.</li>`;

    expenses.forEach(expense => {
        const typeColor = expense.type === 'income' ? 'text-green-400' : 'text-red-400';
        const sign = expense.type === 'income' ? '+' : '-';
        const date = expense.timestamp ? new Date(expense.timestamp.seconds*1000).toLocaleString() : 'N/A';

        const li = document.createElement('li');
        li.className = 'flex justify-between items-center p-4 bg-gray-900 rounded-2xl shadow-lg border border-gray-700 mb-3 hover:bg-gray-800 transition';
        li.innerHTML = `
            <div class="flex-grow min-w-0">
                <p class="font-semibold text-white truncate">${expense.description}</p>
                <p class="text-xs text-gray-500">
                    <i data-lucide="clock" class="w-3 h-3 inline mr-1"></i>${date}
                    <span class="hidden sm:inline">| Recorded by: ${expense.recordedBy.substring(0,8)}...</span>
                </p>
            </div>
            <div class="flex items-center space-x-3 flex-shrink-0">
                <p class="font-bold text-lg ${typeColor}">${sign}${formatter.format(expense.amount)}</p>
                <button onclick="deleteExpense('${expense.id}')" class="text-gray-500 hover:text-red-500 transition p-2 rounded-full bg-gray-700/50 hover:bg-red-900">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `;
        list.appendChild(li);
    });
    lucide.createIcons();
}

function renderSummary(income, expense) {
    const balance = income - expense;
    const balanceColor = balance >= 0 ? 'text-green-400' : 'text-red-400';
    document.getElementById('total-income').textContent = formatter.format(income);
    document.getElementById('total-expense').textContent = formatter.format(expense);
    document.getElementById('net-balance').textContent = formatter.format(balance);
    document.getElementById('net-balance').className = `text-4xl font-black ${balanceColor} mt-2 transition-colors duration-500`;
}

function showMessage(el, text, color) {
    el.textContent = text;
    el.className = `mt-4 text-sm font-semibold text-center text-${color}-400`;
    setTimeout(() => el.textContent = '', 3000);
}

// Expose to HTML
window.addExpense = addExpense;
window.deleteExpense = deleteExpense;

window.onload = setupFirebase;
</script>

<script>
    // --- Admin Password Logic ---
    const ADMIN_PASSWORD = "crrc2025!";
    const adminModal = document.getElementById('admin-modal');
    const adminSection = document.getElementById('admin-section');
    const adminError = document.getElementById('admin-error');
    const adminInput = document.getElementById('admin-password-input');

    function showAdminModal() {
        adminInput.value = '';
        adminError.classList.add('hidden');
        adminModal.classList.remove('hidden');
    }

    function checkAdminPassword() {
        if(adminInput.value === ADMIN_PASSWORD){
            adminModal.classList.add('hidden');
            adminSection.classList.remove('hidden');
            adminError.classList.add('hidden');
            adminSection.scrollIntoView({behavior:'smooth'});
        } else {
            adminError.classList.remove('hidden');
            adminInput.value='';
        }
    }

    adminInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); checkAdminPassword(); } });

    // --- Mobile Menu Toggle ---
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    mobileMenuBtn.addEventListener('click', ()=>{
        mobileMenu.classList.toggle('hidden');
        mobileMenuBtn.querySelector('i').setAttribute('data-lucide', mobileMenu.classList.contains('hidden') ? 'menu' : 'x');
        lucide.createIcons();
    });
    document.querySelectorAll('.nav-link').forEach(link=>{
        link.addEventListener('click', ()=>{ mobileMenu.classList.add('hidden'); mobileMenuBtn.querySelector('i').setAttribute('data-lucide','menu'); lucide.createIcons(); });
    });

    lucide.createIcons();
    window.showAdminModal = showAdminModal;
    window.checkAdminPassword = checkAdminPassword;
</script>
